<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:width="http://www.w3.org/1999/xhtml"
      th:replace="~{layout :: layout(~{::title}, ~{::section})}">
<head>
    <title>Dados do Viveiro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
<section class="container mt-5">

    <!-- Cabeçalho -->
    <div class="row my-5">
        <div class="col">
            <h1 class="text-center">Perfil do Viveiro</h1>
            <p class="text-center">Aqui você pode gerenciar todos os dados e informações do viveiro.</p>
        </div>
    </div>

    <!-- Abas -->
    <ul class="nav nav-tabs justify-content-center mb-4">
        <li class="nav-item">
            <a class="nav-link active"
               th:href="@{/fazenda/{id}/viveiro/{idViveiro}/abrirViveiro(id=${idFazenda}, idViveiro=${idViveiro})}">
                Detalhes do Viveiro
            </a>
        </li>

        <!-- Histórico de Biometria (só visível quando ciclo ativo) -->
        <li class="nav-item" th:if="${cicloViveiro != null and cicloViveiro.ativo}">
            <a class="nav-link"
               th:href="@{/fazendas/{id}/viveiro/{idViveiro}/historico_biometria(id=${idFazenda}, idViveiro=${idViveiro})}">
                Histórico de Biometria
            </a>
        </li>

        <!-- Histórico de Qualidade de Água (só visível quando ciclo ativo) -->
        <li class="nav-item" th:if="${cicloViveiro != null and cicloViveiro.ativo}">
            <a class="nav-link"
               th:href="@{/fazenda/{id}/viveiro/{idViveiro}/historico_agua(id=${idFazenda}, idViveiro=${idViveiro})}">
                Histórico de Qualidade de Água
            </a>
        </li>

        <li class="nav-item">
            <a class="nav-link"
               th:href="@{/fazenda/{id}/viveiro/{idViveiro}/relatorio_viveiro(id=${idFazenda}, idViveiro=${idViveiro})}">
                Relatórios Passados
            </a>
        </li>
    </ul>

    <!-- Linha: Informações Básicas + Instruções Recentes -->
    <div class="row mb-4">
        <!-- Informações Básicas -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Informações Básicas</h3>
                <a th:href="@{/fazenda/{id}(id=${idFazenda})}" class="btn btn-danger btn-sm">Voltar</a>
            </div>
            <form class="d-flex flex-row gap-3">
                <div class="mb-3">
                    <label for="id" class="form-label">Id:</label>
                    <input type="text" class="form-control" id="id" th:value="${viveiro.id}" readonly>
                </div>
                <div class="mb-3">
                    <label for="area" class="form-label">Área:</label>
                    <input type="text" class="form-control" id="area" th:value="${viveiro.area}" readonly>
                </div>
            </form>
        </div>

        <!-- Instruções Recentes -->
        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span>Instruções Recentes</span>
                    <a th:href="@{/fazendas/{id}/viveiros/{idViveiro}/instrucoes(id=${idFazenda}, idViveiro=${idViveiro})}"
                       class="btn btn-sm btn-light">Ver Todas</a>
                </div>

                <div class="card-body">
                    <div th:if="${instrucoes != null and !instrucoes.isEmpty()}">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"
                                th:each="instrucao : ${instrucoes}">
                                <span th:text="${instrucao.status.name() == 'PENDENTE' ? '⚠️ Pendente:' : '✅ Concluída:'}"></span>
                                <strong th:text="${instrucao.titulo}">Título</strong>
                                <br>
                                <small class="text-muted"
                                       th:text="${#temporals.format(instrucao.dataCriacao, 'dd/MM/yyyy')}"></small>
                            </li>
                        </ul>
                    </div>

                    <div th:if="${instrucoes == null or instrucoes.isEmpty()}" class="text-center text-muted">
                        Nenhuma instrução registrada ainda.
                    </div>
                </div>

                <div class="card-footer d-flex justify-content-end mt-auto">
                    <!-- Botão que abre modal de nova instrução -->
                    <button class="btn btn-sm btn-success"
                            th:attr="data-url=@{/fazendas/{id}/viveiros/{idViveiro}/instrucoes/nova(id=${idFazenda}, idViveiro=${idViveiro})}"
                            onclick="abrirModal(this)">
                        + Nova Instrução
                    </button>
                </div>
            </div>
        </div>
        <!-- Container do modal (mesmo usado em outras páginas) -->
        <div id="modal-container" class="modal fade" tabindex="-1"></div>
    </div>

    <!-- Linha: Ciclo + Consumo -->
    <div class="row mb-5 d-flex flex-wrap">
        <!-- Card: Ciclo do Viveiro -->
        <div class="mb-4 d-flex"
             th:class="|card-col ${(cicloViveiro != null and cicloViveiro.ativo) ? 'col-md-6' : 'col-12'}|">
            <div class="card h-100 w-100">
                <div class="card-header bg-info text-white">Ciclo do Viveiro</div>
                <div class="card-body">
                    <!-- Se não houver ciclo ou não estiver ativo -->
                    <div th:if="${cicloViveiro == null or !cicloViveiro.ativo}">
                        <h3 class="text-center mb-1 mt-3">O viveiro não possui um ciclo de criação ativo</h3>
                        <span class="d-block text-center text-muted mt-1 mb-3">
                            Veja os relatórios passados ou inicie um novo ciclo para acessar os controles
                        </span>
                    </div>

                    <!-- Se houver ciclo ativo -->
                    <div th:if="${cicloViveiro != null and cicloViveiro.ativo}">
                        <p><strong>Laboratório:</strong> <span th:text="${cicloViveiro.laboratorio}">---</span></p>
                        <p><strong>Data de Povoamento:</strong> <span th:text="${cicloViveiro.dataPovoamento}">---</span></p>
                        <p><strong>Quantidade Povoada:</strong> <span th:text="${cicloViveiro.quantidadePovoada}">0</span></p>
                    </div>
                </div>

                <!-- Rodapés -->
                <div th:if="${cicloViveiro == null or !cicloViveiro.ativo}"
                     class="card-footer d-flex justify-content-end mt-auto">
                    <a th:href="@{/fazendas/{id}/viveiro/{idViveiro}/formulario_ciclo_viveiro(id=${idFazenda}, idViveiro=${idViveiro})}"
                       class="btn btn-sm bg-info text-white">Iniciar Novo Ciclo</a>
                </div>
                <div th:if="${cicloViveiro != null and cicloViveiro.ativo}"
                     class="card-footer d-flex justify-content-end mt-auto">
                    <a th:href="@{/fazendas/{id}/viveiro/{idViveiro}/ciclo/finalizar(id=${idFazenda}, idViveiro=${idViveiro})}"
                       class="btn btn-sm bg-info text-white">Finalizar Ciclo</a>
                </div>
            </div>
        </div>

        <!-- Card: Consumo de Ração -->
        <div class="mb-4 d-flex h-100"
             th:if="${cicloViveiro != null and cicloViveiro.ativo}"
             th:class="|card-col col-md-6|">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">Consumo de Ração</div>
                <div class="card-body">
                    <table class="table table-bordered table-striped align-middle text-center">
                        <tbody>
                        <tr>
                            <th scope="row">Ração Engorda</th>
                            <td th:text="${cicloViveiro.consumoRacaoEngorda()} + ' Kg'">--</td>
                        </tr>
                        <tr>
                            <th scope="row">Ração Crescimento</th>
                            <td th:text="${cicloViveiro.consumoRacaoCrescimento()} + ' Kg'">--</td>
                        </tr>
                        </tbody>
                    </table>
                    <table class="table table-bordered table-striped align-middle text-center">
                        <tbody>
                        <tr>
                            <th scope="row">Consumo Total</th>
                            <td th:text="${cicloViveiro.consumoTotalRacao()} + ' Kg'">--</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer d-flex justify-content-end mt-auto">
                    <a th:href="@{/fazenda/{id}/viveiro/{idViveiro}/consumir-racao(id=${idFazenda}, idViveiro=${idViveiro})}"
                       class="btn btn-sm bg-primary text-white">Registrar Consumo</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Card: Biometria -->
    <div class="col-md-12 mb-4" th:if="${cicloViveiro != null and cicloViveiro.ativo}">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">Dados de Biometria</div>
            <div class="card-body">
                <table class="table table-bordered align-middle">
                    <thead>
                    <tr>
                        <th></th>
                        <th class="text-center">Última Biometria</th>
                        <th class="text-center">Coleta Anterior</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th scope="row">Data</th>
                        <td class="text-center" th:text="${ultimaBiometria != null ? ultimaBiometria.dataColeta : '---'}"></td>
                        <td class="text-center" th:text="${penultimaBiometria != null ? penultimaBiometria.dataColeta : '---'}"></td>
                    </tr>
                    <tr>
                        <th scope="row">Quantidade</th>
                        <td class="text-center" th:text="${ultimaBiometria != null ? ultimaBiometria.quantidadeAmostra : '---'}"></td>
                        <td class="text-center" th:text="${penultimaBiometria != null ? penultimaBiometria.quantidadeAmostra : '---'}"></td>
                    </tr>
                    <tr>
                        <th scope="row">Peso Total (g)</th>
                        <td class="text-center" th:text="${ultimaBiometria != null ? ultimaBiometria.pesoTotalAmostra : '---'}"></td>
                        <td class="text-center" th:text="${penultimaBiometria != null ? penultimaBiometria.pesoTotalAmostra : '---'}"></td>
                    </tr>
                    <tr>
                        <th scope="row">Peso Médio (g)</th>
                        <td class="text-center" th:text="${ultimaBiometria != null ? ultimaBiometria.calculaBiometria() : '---'}"></td>
                        <td class="text-center" th:text="${penultimaBiometria != null ? penultimaBiometria.calculaBiometria() : '---'}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-flex justify-content-end mt-auto">
                <a th:href="@{/fazendas/{id}/viveiro/{idViveiro}/formulario_biometria(id=${idFazenda}, idViveiro=${idViveiro})}"
                   class="btn btn-sm btn-primary">Atualizar Biometria</a>
            </div>
        </div>
    </div>

    <!-- Card: Qualidade de Água -->
    <div class="col-md-12 mb-4" th:if="${cicloViveiro != null and cicloViveiro.ativo}">
        <div class="card h-100">
            <div class="card-header bg-info text-white">Dados da Qualidade de Água</div>
            <div class="card-body">
                <table class="table table-bordered align-middle">
                    <thead>
                    <tr>
                        <th></th>
                        <th class="text-center">Última Análise</th>
                        <th class="text-center">Coleta Anterior</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th scope="row">Data</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.dataColeta : '---'}"></td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.dataColeta : '---'}"></td>
                    </tr>
                    <tr>
                        <th scope="row">Amônia</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.amonia : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.amonia : '---'}">--</td>
                    </tr>
                    <tr>
                        <th scope="row">Nitrito</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.nitrito : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.nitrito : '---'}">--</td>
                    </tr>
                    <tr>
                        <th scope="row">pH</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.ph : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.ph : '---'}">--</td>
                    </tr>
                    <tr>
                        <th scope="row">Alcalinidade</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.alcalinidade : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.alcalinidade : '---'}">--</td>
                    </tr>
                    <tr>
                        <th scope="row">Salinidade</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.salinidade : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.salinidade : '---'}">--</td>
                    </tr>
                    <tr>
                        <th scope="row">Oxigênio</th>
                        <td class="text-center" th:text="${ultimaQualidade != null ? ultimaQualidade.oxigenio : '---'}">--</td>
                        <td class="text-center" th:text="${qtdeQualidade > 1 ? penultimaQualidade.oxigenio : '---'}">--</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-flex justify-content-end mt-auto">
                <a th:href="@{/fazenda/{id}/viveiro/{idViveiro}/formulario_qualidade_de_agua(id=${idFazenda}, idViveiro=${idViveiro})}"
                   class="btn btn-sm btn-info">Atualizar Análise</a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function abrirModal(btn) {
            const url = btn.getAttribute('data-url');
            fetch(url)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('modal-container').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('modal-container'));
                    modal.show();

                    // recarrega o card após o fechamento do modal
                    document.getElementById('modal-container')
                        .addEventListener('hidden.bs.modal', () => window.location.reload());
                });
        }
    </script>
</section>
</body>
</html>
